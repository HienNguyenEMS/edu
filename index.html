
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMan - Hệ thống Quản lý Trường học Toàn diện</title>

    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 72px; 
            --header-height: 70px;
            --sidebar-bg: #1c2b36; 
            --sidebar-header-bg: #131e28;
            --sidebar-link-color: #aeb9c2;
            --sidebar-link-hover-bg: #293d4e;
            --sidebar-link-active-bg: #0d6efd;
            --bs-primary-rgb: 13, 110, 253;
            --bs-body-font-family: 'Be Vietnam Pro', sans-serif;
            --bs-body-bg: #f8f9fc;
        }
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        #content { width: 100%; min-height: 100vh; transition: margin-left 0.3s ease-in-out; }
        #sidebar { display: flex; flex-direction: column; background: var(--sidebar-bg); color: #fff; transition: all 0.3s ease-in-out; z-index: 1040; }
        #sidebar .sidebar-header { height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: var(--sidebar-header-bg); flex-shrink: 0; }
        #sidebar .logo-container { text-decoration: none; color: white; display: flex; align-items: center; overflow: hidden; }
        #sidebar .logo { height: 40px; flex-shrink: 0; }
        #sidebar .logo-text { margin-left: 10px; font-weight: 700; font-size: 1.5rem; white-space: nowrap; transition: opacity 0.2s, width 0.2s, margin-left 0.2s; }
        #sidebar .components { padding: 15px 0; flex-grow: 1; overflow-y: auto; }
        #sidebar .components a { padding: 12px 20px; font-size: 0.95rem; display: flex; align-items: center; color: var(--sidebar-link-color); border-left: 4px solid transparent; text-decoration: none; transition: all 0.2s ease; white-space: nowrap; }
        #sidebar .components a:hover { color: #fff; background: var(--sidebar-link-hover-bg); }
        #sidebar .components li.active > a { color: #fff; font-weight: 600; background: var(--sidebar-link-active-bg); border-left-color: #f8f9fa; }
        #sidebar .sidebar-heading { padding: 10px 20px; font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: 700; }
        #sidebar .fa-fw { font-size: 1.1rem; width: 30px; text-align: center; }
        #sidebar a[data-bs-toggle="collapse"] .collapse-icon { margin-left: auto; transition: transform 0.3s ease; font-size: 0.8rem; }
        #sidebar a[data-bs-toggle="collapse"][aria-expanded="true"] .collapse-icon { transform: rotate(-180deg); }
        #sidebar .collapse a { padding-left: calc(20px + 30px); font-size: 0.9rem; background: rgba(0,0,0,0.2); }
        .main-header { height: var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; background-color: #fff; border-bottom: 1px solid #e3e6f0; position: sticky; top: 0; z-index: 1020; }
        .main-content.active { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); border: 1px solid #e3e6f0; }
        .card-header { font-weight: 600; color: #343a40; background-color: #eef2f7; border-bottom: 1px solid #dee2e6; }
        .table > thead { background-color: #f3f6fc; vertical-align: middle; }
        .table > thead th { font-weight: 600; border-bottom-width: 1px !important; border-color: #e3e6f0 !important; }
        .kpi-card { border: 1px solid #e3e6f0; box-shadow: 0 0.1rem 0.5rem rgba(0,0,0,0.05); }
        .kpi-card .card-body { padding: 1rem; }
        #sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: var(--sidebar-width); transform: translateX(-100%); }
        #sidebar.show { transform: translateX(0); }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1039; display: none; }
        #sidebar-overlay.active { display: block; }
        #content { margin-left: 0; }
        .nav-tabs-responsive { display: flex; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-tabs-responsive .nav-link { white-space: nowrap; }
        .chat-container .list-group-item { cursor: pointer; }
        .chat-body { height: 400px; overflow-y: auto; }
        .chat-message { margin-bottom: 1rem; }
        .chat-message.right { text-align: right; }
        .chat-message.right .message-content { background-color: var(--bs-primary); color: white; }
        .message-content { display: inline-block; padding: 0.5rem 1rem; border-radius: 1rem; max-width: 80%; }
        /* Kanban Board Styles */
        .kanban-board { display: flex; gap: 1.5rem; overflow-x: auto; padding-bottom: 1rem;}
        .kanban-column { min-width: 300px; flex-shrink: 0; width: 300px; }
        .kanban-column .card-header { font-size: 0.9rem; }
        .kanban-column .card-body { background-color: #f8f9fc; height: 65vh; overflow-y: auto; }
        .kanban-task { background-color: #fff; border: 1px solid #e3e6f0; padding: 0.8rem; border-radius: 0.375rem; margin-bottom: 0.75rem; cursor: pointer; }
        .kanban-task:hover { box-shadow: 0 0.15rem 1rem 0 rgba(58, 59, 69, 0.15); }
        .task-title { font-weight: 600; margin-bottom: 0.25rem; }
        .task-meta { font-size: 0.8rem; color: #6c757d; }
        .task-assignees img { width: 24px; height: 24px; }
        
        @media (min-width: 992px) {
            #sidebar { position: fixed; transform: translateX(0); }
            #sidebar-overlay { display: none !important; }
            #content { margin-left: var(--sidebar-width); }
            body.sidebar-collapsed #content { margin-left: var(--sidebar-collapsed-width); }
            body.sidebar-collapsed #sidebar { width: var(--sidebar-collapsed-width); }
            body.sidebar-collapsed #sidebar .logo-container { justify-content: center; }
            body.sidebar-collapsed #sidebar .logo-text,
            body.sidebar-collapsed #sidebar .nav-link span,
            body.sidebar-collapsed #sidebar .collapse-icon,
            body.sidebar-collapsed #sidebar .sidebar-heading { opacity: 0; width: 0; height: 0; overflow: hidden; margin: 0; padding: 0; }
            body.sidebar-collapsed #sidebar .nav-link { justify-content: center; padding-left: 10px; padding-right: 10px; }
            body.sidebar-collapsed #sidebar .fa-fw { margin-right: 0 !important; font-size: 1.5rem; }
            body.sidebar-collapsed #sidebar .collapse.show { display: none; }
        }
    </style>
</head>
<body>

<div id="sidebar-overlay"></div>
<div class="wrapper">
    <!-- === START: Sidebar === -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo-container nav-link" data-view="dashboard">
                <img src="https://cdn-icons-png.flaticon.com/512/2997/2997723.png" alt="Logo" class="logo">
                <span class="logo-text">EduMan</span>
            </a>
            <button class="btn btn-dark d-none d-lg-block" type="button" id="desktop-sidebar-toggle-btn"><i class="fas fa-bars"></i></button>
        </div>
        <ul class="list-unstyled components">
            <li><a href="#" class="nav-link" data-view="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i><span>Tổng quan</span></a></li>
            <li><a href="#" class="nav-link" data-view="analytics"><i class="fas fa-chart-line fa-fw"></i><span>Báo cáo & Thống kê</span></a></li>

            <div class="sidebar-heading">Học vụ</div>
            <li>
                <a href="#studentSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-user-graduate fa-fw"></i><span>Học sinh</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="studentSubmenu">
                    <li><a href="#" class="nav-link" data-view="students"><span>Hồ sơ học sinh</span></a></li>
                    <li><a href="#" class="nav-link" data-view="discipline"><span>Khen thưởng & Kỷ luật</span></a></li>
                </ul>
            </li>
             <li>
                <a href="#classSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-chalkboard-teacher fa-fw"></i><span>Lớp học</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="classSubmenu">
                    <li><a href="#" class="nav-link" data-view="classes"><span>Danh sách Lớp</span></a></li>
                    <li><a href="#" class="nav-link" data-view="attendance"><span>Điểm danh</span></a></li>
                </ul>
            </li>

            <div class="sidebar-heading">Giảng dạy</div>
             <li>
                <a href="#teachingSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-book-reader fa-fw"></i><span>Giảng dạy</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="teachingSubmenu">
                    <li><a href="#" class="nav-link" data-view="timetable"><span>Thời khóa biểu</span></a></li>
                    <li><a href="#" class="nav-link" data-view="grades"><span>Học tập & Điểm số</span></a></li>
                    <li><a href="#" class="nav-link" data-view="teaching-log"><span>Sổ đầu bài điện tử</span></a></li>
                </ul>
            </li>

            <div class="sidebar-heading">Nội bộ</div>
             <li>
                <a href="#hrSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-users-cog fa-fw"></i><span>Nhân sự</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="hrSubmenu">
                    <li><a href="#" class="nav-link" data-view="teachers"><span>Hồ sơ CB-GV-NV</span></a></li>
                    <li><a href="#" class="nav-link" data-view="teaching-stats"><span>Bảng kê giờ giảng</span></a></li>
                    <li><a href="#" class="nav-link" data-view="teacher-attendance"><span>Chấm công</span></a></li>
                    <li><a href="#" class="nav-link" data-view="leave"><span>Quản lý nghỉ phép</span></a></li>
                </ul>
            </li>
            <li>
                <a href="#financeSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-wallet fa-fw"></i><span>Tài chính</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="financeSubmenu">
                    <li><a href="#" class="nav-link" data-view="tuition"><span>Quản lý Học phí</span></a></li>
                    <li><a href="#" class="nav-link" data-view="finance-vouchers"><span>Các khoản Thu - Chi</span></a></li>
                </ul>
            </li>

            <div class="sidebar-heading">Tương tác</div>
             <li>
                <a href="#parentSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-comments fa-fw"></i><span>Phụ huynh</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="parentSubmenu">
                    <li><a href="#" class="nav-link" data-view="communication"><span>Sổ liên lạc điện tử</span></a></li>
                    <li><a href="#" class="nav-link" data-view="parent-corner"><span>Góc học tập PH</span></a></li>
                    <li><a href="#" class="nav-link" data-view="leave-requests"><span>Đơn xin nghỉ học</span></a></li>
                </ul>
            </li>
            
            <div class="sidebar-heading">Hệ thống</div>
            <li>
                <a href="#settingsSubmenu" data-bs-toggle="collapse" class="nav-link">
                    <i class="fas fa-cogs fa-fw"></i><span>Quản trị</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </a>
                <ul class="collapse list-unstyled" id="settingsSubmenu">
                    <li><a href="#" class="nav-link" data-view="announcements"><span>Thông báo chung</span></a></li>
                    <li><a href="#" class="nav-link" data-view="documents"><span>Văn bản & Công văn</span></a></li>
                    <li><a href="#" class="nav-link" data-view="tasks"><span>Giao việc & Báo cáo</span></a></li>
                    <li><a href="#" class="nav-link" data-view="school-data"><span>Dữ liệu trường học</span></a></li>
                    <li><a href="#" class="nav-link" data-view="roles"><span>Phân quyền</span></a></li>
                    <li><a href="#" class="nav-link" data-view="user-guide"><span>Hướng dẫn sử dụng</span></a></li>
                </ul>
            </li>
        </ul>
    </nav>
    <!-- === END: Sidebar === -->

    <div id="content">
        <!-- === START: Header === -->
        <header class="main-header">
            <div class="d-flex align-items-center gap-2 w-100">
                <button class="btn border-0 d-lg-none" type="button" id="mobile-sidebar-toggle-btn"><i class="fas fa-bars fs-4"></i></button>
                <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control bg-light border-0" id="global-search-input" placeholder="Tìm kiếm...">
                </div>
            </div>
            <div class="d-flex align-items-center flex-shrink-0 ms-3">
                 <div class="dropdown">
                    <a class="nav-link" href="#" role="button" data-bs-toggle="dropdown"><i class="fas fa-bell fa-fw fs-4 text-secondary"></i><span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">4<span class="visually-hidden">unread</span></span></a>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="width: 350px;">
                        <li class="dropdown-header">Thông báo mới</li>
                        <li><a class="dropdown-item d-flex align-items-start" href="#"><div class="me-3"><div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-file-alt"></i></div></div><div><div class="small text-muted">1 giờ trước</div><span class="fw-bold">PH HS Nguyễn An có phản hồi mới.</span></div></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-start" href="#"><div class="me-3"><div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-calendar-check"></i></div></div><div><div class="small text-muted">Hôm qua</div><span>Đã duyệt đơn nghỉ phép của GV Trần Văn Hùng.</span></div></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-start" href="#"><div class="me-3"><div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-money-bill-wave"></i></div></div><div><div class="small text-muted">08/07/2024</div><span>Hệ thống ghi nhận khoản thu học phí mới từ PH em Lê Thị Cẩm.</span></div></a></li>
                         <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-start" href="#"><div class="me-3"><div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-bullhorn"></i></div></div><div><div class="small text-muted">07/07/2024</div><span>BGH đã đăng thông báo mới về lịch thi học kỳ.</span></div></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center small text-muted" href="#">Xem tất cả</a></li>
                    </ul>
                </div>
                <div class="dropdown ms-3">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                        <img src="https://i.pravatar.cc/40?u=admin" alt="Avatar" width="40" height="40" class="rounded-circle me-2">
                        <div><strong class="d-block">Cô Hiệu Trưởng</strong><small class="text-muted">BGH</small></div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                        <li><a class="dropdown-item nav-link-profile" data-view="my-profile" href="#"><i class="fas fa-user-circle fa-fw me-2"></i>Thông tin cá nhân</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt fa-fw me-2"></i>Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </header>
        <!-- === END: Header === -->
        <main id="main-content-area" class="p-3 p-lg-4"></main>
    </div>
</div>

<!-- === START: Modals (All modals are here) === -->
<!-- Task Modal -->
<div class="modal fade" id="task-modal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="taskModalLabel">Thêm Công việc mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="task-form"><input type="hidden" name="id"><div class="row g-3"><div class="col-12"><label class="form-label">Tên công việc</label><input type="text" name="task_name" class="form-control" placeholder="VD: Chuẩn bị cho lễ khai giảng"></div><div class="col-md-6"><label class="form-label">Giao cho</label><select name="assignee" class="form-select"><option>Tổ Văn phòng</option><option>Tổ Toán-Tin</option><option>Cô Nguyễn Thị Mai</option></select></div><div class="col-md-6"><label class="form-label">Hạn chót</label><input type="date" name="due_date" class="form-control"></div><div class="col-12"><label class="form-label">Mô tả chi tiết</label><textarea name="description" class="form-control" rows="4"></textarea></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary">Lưu</button></div></div></div></div>
<!-- Task Detail Modal -->
<div class="modal fade" id="task-detail-modal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="taskDetailModalLabel">Chi tiết công việc: Chuẩn bị cho Lễ khai giảng</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-8"><h6 class="text-primary">Mô tả</h6><p>Lên kế hoạch chi tiết, phân công nhân sự và dự trù kinh phí cho Lễ khai giảng năm học 2024-2025. Hoàn thành và trình BGH trước ngày 15/08.</p><hr><h6 class="text-primary">Trao đổi & Báo cáo</h6><div class="mb-3"><div class="d-flex align-items-start mb-3"><img src="https://i.pravatar.cc/40?u=vp" class="rounded-circle me-2" alt="avatar"><div class="flex-grow-1"><div class="bg-light p-2 rounded"><strong>Tổ Văn phòng:</strong> Đã hoàn thành dự trù kinh phí. File đính kèm.<br><a href="#"><i class="fas fa-paperclip me-1"></i> DuTruKinhPhi.xlsx</a></div><small class="text-muted">2 giờ trước</small></div></div><div class="d-flex align-items-start"><img src="https://i.pravatar.cc/40?u=admin" class="rounded-circle me-2" alt="avatar"><div class="flex-grow-1"><div class="bg-light p-2 rounded"><strong>Cô Hiệu trưởng:</strong> Tốt lắm, các đồng chí tiếp tục triển khai các hạng mục còn lại nhé.</div><small class="text-muted">1 giờ trước</small></div></div></div><div class="input-group"><input type="text" class="form-control" placeholder="Viết bình luận hoặc báo cáo..."><button class="btn btn-outline-secondary" type="button"><i class="fas fa-paperclip"></i></button><button class="btn btn-primary" type="button">Gửi</button></div></div><div class="col-md-4"><div class="card"><div class="card-body"><h6 class="text-primary">Thông tin</h6><p class="mb-1"><strong>Giao cho:</strong> Tổ Văn phòng</p><p class="mb-1"><strong>Người tạo:</strong> Cô Hiệu trưởng</p><p class="mb-1"><strong>Ngày giao:</strong> 01/08/2024</p><p class="mb-1"><strong>Hạn chót:</strong> 15/08/2024</p><p class="mb-1"><strong>Trạng thái:</strong> <span class="badge bg-primary">Đang làm</span></p><hr><h6 class="text-primary">File đính kèm</h6><ul class="list-unstyled"><li><a href="#"><i class="fas fa-file-word me-2"></i>KeHoachKhaiGiang.docx</a></li></ul></div></div></div></div></div></div></div></div>
<!-- Document Modal -->
<div class="modal fade" id="document-modal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="documentModalLabel">Thêm Văn bản mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="document-form"><input type="hidden" name="id"><div class="row g-3"><div class="col-md-6"><label class="form-label">Số hiệu văn bản</label><input type="text" name="doc_id" class="form-control"></div><div class="col-md-6"><label class="form-label">Ngày ban hành</label><input type="date" name="issue_date" class="form-control"></div><div class="col-12"><label class="form-label">Trích yếu nội dung</label><input type="text" name="title" class="form-control"></div><div class="col-md-6"><label class="form-label">Nơi ban hành / Nơi gửi</label><input type="text" name="sender" class="form-control"></div><div class="col-md-6"><label class="form-label">Người/Bộ phận xử lý chính</label><select name="handler" class="form-select"><option>BGH</option><option>Tổ Văn phòng</option></select></div><div class="col-12"><label class="form-label">File đính kèm</label><input type="file" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary">Lưu</button></div></div></div></div>
<!-- Student Modal -->
<div class="modal fade" id="student-modal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="studentModalLabel">Hồ sơ Học sinh</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="student-form"><input type="hidden" name="id"><h6 class="text-primary">Thông tin học sinh</h6><hr class="mt-1"><div class="row g-3"><div class="col-md-4"><label class="form-label">Mã học sinh</label><input type="text" name="student_code" class="form-control" placeholder="Hệ thống tự tạo..." readonly></div><div class="col-md-4"><label class="form-label">Họ và tên</label><input type="text" name="full_name" class="form-control"></div><div class="col-md-4"><label class="form-label">Ngày sinh</label><input type="date" name="dob" class="form-control"></div><div class="col-md-3"><label class="form-label">Giới tính</label><select name="gender" class="form-select"><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div><div class="col-md-3"><label class="form-label">Dân tộc</label><input type="text" name="ethnicity" class="form-control" value="Kinh"></div><div class="col-md-6"><label class="form-label">Nơi sinh</label><input type="text" name="birth_place" class="form-control"></div><div class="col-md-4"><label class="form-label">Đối tượng ưu tiên</label><select name="priority_group" class="form-select"><option>Không</option><option>Con thương binh</option></select></div><div class="col-md-4"><label class="form-label">Lớp</label><select name="class_id" class="form-select"><option>1A</option><option>6B</option><option>10A1</option><option>11B2</option><option>12A3</option></select></div><div class="col-md-4"><label class="form-label">Trạng thái</label><select name="status" class="form-select"><option value="Đang học">Đang học</option><option value="Thôi học">Thôi học</option><option value="Bảo lưu">Bảo lưu</option></select></div></div><h6 class="text-primary mt-4">Thông tin phụ huynh</h6><hr class="mt-1"><div class="row g-3"><div class="col-md-6"><label class="form-label">Họ tên Cha</label><input type="text" name="father_name" class="form-control"></div><div class="col-md-6"><label class="form-label">SĐT Cha</label><input type="tel" name="father_phone" class="form-control"></div><div class="col-md-6"><label class="form-label">Họ tên Mẹ</label><input type="text" name="mother_name" class="form-control"></div><div class="col-md-6"><label class="form-label">SĐT Mẹ</label><input type="tel" name="mother_phone" class="form-control"></div><div class="col-12"><label class="form-label">Địa chỉ thường trú</label><input type="text" name="address" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary">Lưu</button></div></div></div></div>
<!-- Other modals from Phase 1... -->
<div class="modal fade" id="discipline-modal" tabindex="-1" aria-labelledby="disciplineModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="disciplineModalLabel">Thêm/Sửa Khen thưởng - Kỷ luật (Học sinh)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="discipline-form"><input type="hidden" name="id"><div class="row g-3"><div class="col-md-6"><label class="form-label">Học sinh</label><select name="student_name" class="form-select"><option>Nguyễn Văn An</option><option>Trần Thị Bình</option><option>Lê Minh Châu</option><option>Phạm Thị Dung</option></select></div><div class="col-md-6"><label class="form-label">Ngày quyết định</label><input type="date" name="date" class="form-control"></div><div class="col-md-6"><label class="form-label">Phân loại</label><select name="type" class="form-select"><option value="Khen thưởng">Khen thưởng</option><option value="Kỷ luật">Kỷ luật</option></select></div><div class="col-md-6"><label class="form-label">Cấp quyết định</label><input type="text" name="decider" class="form-control" value="Ban Giám Hiệu"></div><div class="col-12"><label class="form-label">Nội dung chi tiết</label><textarea name="content" class="form-control" rows="3"></textarea></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary">Lưu</button></div></div></div></div>
<div class="modal fade" id="teacher-discipline-modal" tabindex="-1" aria-labelledby="teacherDisciplineModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="teacherDisciplineModalLabel">Thêm/Sửa Khen thưởng - Kỷ luật (Giáo viên)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="teacher-discipline-form"><input type="hidden" name="id"><div class="row g-3"><div class="col-md-6"><label class="form-label">Ngày quyết định</label><input type="date" name="date" class="form-control"></div><div class="col-md-6"><label class="form-label">Số quyết định</label><input type="text" name="decision_no" class="form-control"></div><div class="col-12"><label class="form-label">Phân loại</label><select name="type" class="form-select"><option value="Khen thưởng">Khen thưởng</option><option value="Kỷ luật">Kỷ luật</option></select></div><div class="col-12"><label class="form-label">Nội dung chi tiết</label><textarea name="content" class="form-control" rows="3"></textarea></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary">Lưu</button></div></div></div></div>
<div class="modal fade" id="feedback-modal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="feedbackModalLabel">Gửi Phản ánh / Góp ý</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="feedback-form"><div class="row g-3"><div class="col-12"><label class="form-label">Gửi đến</label><select name="recipient" class="form-select"><option>Ban Giám Hiệu</option><option>Phòng Tài vụ</option><option>Giáo viên chủ nhiệm lớp 10A1</option></select></div><div class="col-12"><label class="form-label">Tiêu đề</label><input type="text" name="title" class="form-control"></div><div class="col-12"><label class="form-label">Nội dung chi tiết</label><textarea name="content" class="form-control" rows="5"></textarea></div><div class="col-12"><label class="form-label">Đính kèm (nếu có)</label><input type="file" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Gửi đi</button></div></div></div></div>
<div class="modal fade" id="class-modal" tabindex="-1" aria-labelledby="classModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="classModalLabel">Thông tin Lớp học</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="class-form"><input type="hidden" name="id"><div class="row g-3"><div class="col-md-6"><label class="form-label">Tên Lớp</label><input type="text" name="class_name" class="form-control"></div><div class="col-md-6"><label class="form-label">Khối</label><select name="grade" class="form-select"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div><div class="col-md-6"><label class="form-label">Giáo viên chủ nhiệm</label><select name="teacher" class="form-select"><option>Nguyễn Thị Mai</option><option>Trần Văn Hùng</option><option>Lê Thị Thu</option><option>Phạm Văn An</option></select></div><div class="col-md-6"><label class="form-label">Năm học</label><select name="school_year" class="form-select"><option>2024-2025</option><option>2023-2024</option></select></div><div class="col-md-6"><label class="form-label">Sĩ số</label><input type="number" name="size" class="form-control"></div><div class="col-md-6"><label class="form-label">Trạng thái</label><select name="status" class="form-select"><option value="Đang hoạt động">Đang hoạt động</option><option value="Đã kết thúc">Đã kết thúc</option></select></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary">Lưu</button></div></div></div></div>
<!-- === END: Modals === -->


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const mainContentArea = document.getElementById('main-content-area');
    const globalSearchInput = document.getElementById('global-search-input');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const desktopSidebarToggleBtn = document.getElementById('desktop-sidebar-toggle-btn');
    const mobileSidebarToggleBtn = document.getElementById('mobile-sidebar-toggle-btn');

    let chart1 = null, chart2 = null, radarChart = null, barChart = null;
    let bsTooltipList = [];
    
    const searchPlaceholders = {
        dashboard: 'Tìm kiếm chung...', students: 'Tìm theo mã HS, tên, lớp...',
        analytics: 'Tìm kiếm báo cáo, học sinh...',
        grades: 'Tìm theo học sinh, lớp, môn học...', discipline: 'Tìm theo tên học sinh, loại vi phạm...',
        classes: 'Tìm kiếm lớp học...', attendance: 'Tìm kiếm điểm danh theo lớp, ngày...',
        timetable: 'Tìm kiếm theo lớp, giáo viên...', 'teaching-log': 'Tìm kiếm trong sổ đầu bài...',
        teachers: 'Tìm kiếm giáo viên theo tên, tổ...', 'teacher-attendance': 'Tìm kiếm chấm công GV...',
        'teaching-stats': 'Tìm kiếm bảng kê theo giáo viên, tháng...',
        leave: 'Tìm kiếm đơn nghỉ phép GV...', tuition: 'Tìm kiếm học sinh, trạng thái học phí...',
        'finance-vouchers': 'Tìm kiếm phiếu thu, chi...', communication: 'Tìm kiếm trao đổi, phụ huynh...',
        'leave-requests': 'Tìm kiếm đơn xin nghỉ của HS...', announcements: 'Tìm kiếm thông báo...',
        documents: 'Tìm kiếm văn bản theo số hiệu, trích yếu...',
        tasks: 'Tìm kiếm công việc, người thực hiện...',
        'school-data': 'Tìm kiếm dữ liệu trường học...', roles: 'Tìm kiếm vai trò...',
        'user-guide': 'Tìm kiếm hướng dẫn...', 'my-profile': 'Tìm kiếm trong thông tin cá nhân...',
        'parent-corner': 'Tìm kiếm thông tin học tập của con...',
    };
    
    // === START: All View Templates (Fully Populated and Corrected) ===
    const viewTemplates = {
        // === PHASE 2 VIEWS ===
        analytics: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Báo cáo & Phân tích Học tập</h3><button class="btn btn-outline-primary"><i class="fas fa-file-export me-2"></i>Xuất báo cáo tổng hợp</button></div><div class="row"><div class="col-lg-7 mb-4"><div class="card h-100"><div class="card-header">Phổ điểm môn Toán - Khối 10 (HK1)</div><div class="card-body"><canvas id="gradeDistributionChart"></canvas></div></div></div><div class="col-lg-5 mb-4"><div class="card h-100"><div class="card-header">So sánh kết quả học tập các lớp Khối 10</div><div class="card-body"><canvas id="classComparisonChart"></canvas></div></div></div></div><div class="card"><div class="card-header"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Cảnh báo Học lực</div><div class="card-body"><div class="table-responsive"><table class="table table-hover table-sm"><thead><tr><th>Họ và Tên</th><th>Lớp</th><th>Lý do cảnh báo</th><th class="text-center">Hành động</th></tr></thead><tbody><tr class="table-danger"><td>Phạm Văn Dũng</td><td>10A1</td><td>ĐTB môn Lý (6.1), Toán (5.5) dưới 6.5</td><td class="text-center"><button class="btn btn-sm btn-outline-secondary">Gửi thông báo PH</button></td></tr><tr class="table-warning"><td>Mai Thị Hoa</td><td>11A3</td><td>Chuyên cần < 90% (Nghỉ 4 buổi/tháng)</td><td class="text-center"><button class="btn btn-sm btn-outline-secondary">Gửi thông báo PH</button></td></tr><tr class="table-danger"><td>Lê Văn Nam</td><td>12A2</td><td>Có 3 môn điểm tổng kết dưới 5.0</td><td class="text-center"><button class="btn btn-sm btn-outline-secondary">Gửi thông báo PH</button></td></tr></tbody></table></div></div></div>`,
        'teaching-stats': `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Bảng kê giờ giảng</h3><button class="btn btn-primary"><i class="fas fa-file-excel me-2"></i>Xuất Excel</button></div><div class="card"><div class="card-header">Bảng kê chi tiết - Tháng 09/2024</div><div class="card-body"><div class="row g-3 mb-3 align-items-end"><div class="col-md-4"><label class="form-label">Tháng</label><input type="month" class="form-control" value="2024-09"></div><div class="col-md-4"><label class="form-label">Giáo viên</label><select class="form-select"><option>Tất cả</option><option selected>Nguyễn Thị Mai</option><option>Trần Văn Hùng</option></select></div></div><div class="table-responsive"><table class="table table-bordered text-center"><thead><tr><th>STT</th><th class="text-start">Họ tên GV</th><th>Tổng tiết theo TKB</th><th>Số tiết đã dạy</th><th>Số tiết dạy thay</th><th>Số tiết nghỉ</th><th>Tổng số tiết thực dạy</th></tr></thead><tbody><tr><td>1</td><td class="text-start">Nguyễn Thị Mai</td><td>64</td><td>60</td><td>2</td><td>4</td><td class="fw-bold">62</td></tr><tr><td>2</td><td class="text-start">Trần Văn Hùng</td><td>64</td><td>64</td><td>0</td><td>0</td><td class="fw-bold">64</td></tr></tbody></table><p class="mt-2 fst-italic small text-muted">* Ghi chú: Dữ liệu được tổng hợp tự động từ Thời khóa biểu và Sổ đầu bài điện tử.</p></div></div></div>`,
        documents: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Quản lý Văn bản & Công văn</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#document-modal"><i class="fas fa-plus me-2"></i>Thêm văn bản</button></div><div class="card"><div class="card-body"><ul class="nav nav-tabs nav-tabs-responsive mb-3"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-incoming">Văn bản đến</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-outgoing">Văn bản đi</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-incoming"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Số hiệu</th><th>Ngày đến</th><th>Nơi gửi</th><th>Trích yếu</th><th>Trạng thái xử lý</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>123/SGDĐT-TrH</td><td>10/08/2024</td><td>Sở GD&ĐT</td><td>V/v Hướng dẫn nhiệm vụ năm học 2024-2025</td><td><span class="badge bg-success">Đã hoàn thành</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#document-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr><tr><td>45/PGD-THCS</td><td>08/08/2024</td><td>Phòng GD&ĐT</td><td>V/v Kế hoạch bồi dưỡng chuyên môn hè 2024</td><td><span class="badge bg-warning text-dark">Chờ xử lý</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#document-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr></tbody></table></div></div><div class="tab-pane" id="tab-outgoing"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Số hiệu</th><th>Ngày đi</th><th>Nơi nhận</th><th>Trích yếu</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>56/BC-THPT</td><td>15/08/2024</td><td>Sở GD&ĐT</td><td>Báo cáo công tác chuẩn bị cho năm học mới</td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#document-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr></tbody></table></div></div></div></div></div>`,
        tasks: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Quản lý Công việc</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#task-modal"><i class="fas fa-plus me-2"></i>Giao việc mới</button></div><div class="kanban-board"><div class="kanban-column"><div class="card"><div class="card-header bg-secondary-subtle">Cần làm (2)</div><div class="card-body"><div class="kanban-task" data-bs-toggle="modal" data-bs-target="#task-detail-modal"><div class="task-title">Tổ chức Trung thu cho học sinh</div><div class="d-flex justify-content-between align-items-center"><span class="task-meta"><i class="far fa-calendar-alt me-1"></i> 20/09</span><div class="task-assignees"><img src="https://i.pravatar.cc/24?u=dtn" class="rounded-circle border" title="Đoàn Thanh niên"></div></div></div><div class="kanban-task" data-bs-toggle="modal" data-bs-target="#task-detail-modal"><div class="task-title">Kiểm tra cơ sở vật chất</div><div class="d-flex justify-content-between align-items-center"><span class="task-meta"><i class="far fa-calendar-alt me-1"></i> 30/08</span><div class="task-assignees"><img src="https://i.pravatar.cc/24?u=qt" class="rounded-circle border" title="Tổ Quản trị"></div></div></div></div></div></div><div class="kanban-column"><div class="card"><div class="card-header bg-primary-subtle">Đang làm (1)</div><div class="card-body"><div class="kanban-task" data-bs-toggle="modal" data-bs-target="#task-detail-modal"><div class="task-title">Chuẩn bị cho Lễ khai giảng</div><div class="d-flex justify-content-between align-items-center"><span class="task-meta"><i class="far fa-calendar-alt me-1"></i> 15/08</span><div class="task-assignees"><img src="https://i.pravatar.cc/24?u=vp" class="rounded-circle border" title="Tổ Văn phòng"></div></div></div></div></div></div><div class="kanban-column"><div class="card"><div class="card-header bg-warning-subtle">Chờ duyệt (1)</div><div class="card-body"><div class="kanban-task" data-bs-toggle="modal" data-bs-target="#task-detail-modal"><div class="task-title">Kế hoạch bồi dưỡng chuyên môn</div><div class="d-flex justify-content-between align-items-center"><span class="task-meta"><i class="far fa-calendar-alt me-1"></i> 10/08</span><div class="task-assignees"><img src="https://i.pravatar.cc/24?u=gv2" class="rounded-circle border" title="Thầy Hùng"></div></div></div></div></div></div><div class="kanban-column"><div class="card"><div class="card-header bg-success-subtle">Hoàn thành (1)</div><div class="card-body"><div class="kanban-task" data-bs-toggle="modal" data-bs-target="#task-detail-modal"><div class="task-title text-decoration-line-through">Lên danh sách lớp 10</div><div class="d-flex justify-content-between align-items-center"><span class="task-meta"><i class="far fa-calendar-check me-1"></i> 05/08</span><div class="task-assignees"><img src="https://i.pravatar.cc/24?u=gv1" class="rounded-circle border" title="Cô Mai"></div></div></div></div></div></div></div>`,

        // === PHASE 1 VIEWS (UNCHANGED, BUT KEPT FOR COMPLETENESS) ===
        dashboard: `<div class="row"><div class="col-12"><div class="row"><div class="col-6 col-lg-3 mb-4"><div class="card kpi-card bg-primary-subtle border-primary h-100"><div class="card-body"><h6 class="text-muted small text-uppercase mb-2">Sĩ số Toàn trường</h6><h4 class="fw-bold mb-0">1,520</h4></div></div></div><div class="col-6 col-lg-3 mb-4"><div class="card kpi-card bg-success-subtle border-success h-100"><div class="card-body"><h6 class="text-muted small text-uppercase mb-2">Học phí đã thu (tháng)</h6><h4 class="fw-bold mb-0">85%</h4></div></div></div><div class="col-6 col-lg-3 mb-4"><div class="card kpi-card bg-info-subtle border-info h-100"><div class="card-body"><h6 class="text-muted small text-uppercase mb-2">Chuyên cần (Hôm nay)</h6><h4 class="fw-bold mb-0">98.5%</h4></div></div></div><div class="col-6 col-lg-3 mb-4"><div class="card kpi-card bg-warning-subtle border-warning h-100"><div class="card-body"><h6 class="text-muted small text-uppercase mb-2">Đơn nghỉ mới</h4><h4 class="fw-bold mb-0">3</h4></div></div></div></div></div><div class="col-lg-8 mb-4"><div class="card h-100"><div class="card-header">Học lực theo Khối (Học kỳ 1)</div><div class="card-body"><canvas id="performanceByGradeChart"></canvas></div></div></div><div class="col-lg-4 mb-4"><div class="card h-100"><div class="card-header">Tình hình Thu học phí</div><div class="card-body d-flex align-items-center justify-content-center"><div id="tuitionStatusChart" style="min-height: 300px; width:100%"></div></div></div></div></div>`,
        students: `<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2"><h3>Hồ sơ Học sinh</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#student-modal"><i class="fas fa-plus me-2"></i>Thêm học sinh</button></div><div class="card shadow-sm"><div class="card-header">Danh sách Học sinh</div><div class="card-body"><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Mã HS</th><th>Họ và Tên</th><th>Lớp</th><th>Ngày sinh</th><th>Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody>
            <tr data-id="1" data-student_code="HS-001" data-full_name="Nguyễn Văn An" data-dob="2008-05-10" data-gender="Nam" data-class_id="10A1" data-status="Đang học" data-father_name="Nguyễn Văn B" data-father_phone="0909123456"><td>HS-001</td><td><a href="#" class="nav-link p-0 fw-bold" data-view="student-detail">Nguyễn Văn An</a></td><td>10A1</td><td>10/05/2008</td><td><span class="badge bg-success">Đang học</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-info nav-link" data-view="student-detail" title="Xem chi tiết"><i class="fas fa-eye"></i></button><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#student-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr>
            <tr data-id="2" data-student_code="HS-002" data-full_name="Trần Thị Bình" data-dob="2008-08-22" data-gender="Nữ" data-class_id="10A1" data-status="Đang học" data-mother_name="Trần Thị Mai" data-mother_phone="0912987654"><td>HS-002</td><td><a href="#" class="nav-link p-0 fw-bold" data-view="student-detail">Trần Thị Bình</a></td><td>10A1</td><td>22/08/2008</td><td><span class="badge bg-success">Đang học</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-info nav-link" data-view="student-detail" title="Xem chi tiết"><i class="fas fa-eye"></i></button><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#student-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr>
            </tbody></table></div></div></div>`,
        discipline: `<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2"><h3>Khen thưởng & Kỷ luật (Học sinh)</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#discipline-modal"><i class="fas fa-plus me-2"></i>Thêm mới</button></div><div class="card shadow-sm"><div class="card-header">Danh sách Quyết định</div><div class="card-body"><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Ngày</th><th>Họ và Tên</th><th>Lớp</th><th>Phân loại</th><th>Nội dung</th><th class="text-center">Hành động</th></tr></thead><tbody>
            <tr data-id="1" data-student_name="Nguyễn Văn An" data-date="2024-05-20" data-type="Khen thưởng" data-content="Đạt giải Nhất HSG môn Toán cấp trường." data-decider="BGH"><td>20/05/2024</td><td>Nguyễn Văn An</td><td>10A1</td><td><span class="badge bg-success">Khen thưởng</span></td><td>Đạt giải Nhất HSG môn Toán cấp trường.</td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#discipline-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr>
            <tr data-id="2" data-student_name="Trần Thị Bình" data-date="2024-03-15" data-type="Kỷ luật" data-content="Vi phạm nội quy, đi học muộn 3 lần." data-decider="GVCN"><td>15/03/2024</td><td>Trần Thị Bình</td><td>10A1</td><td><span class="badge bg-danger">Kỷ luật</span></td><td>Vi phạm nội quy, đi học muộn 3 lần.</td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#discipline-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr>
            </tbody></table></div></div></div>`,
        'student-detail': `<h3 class="mb-4">Hồ sơ chi tiết: Nguyễn Văn An</h3><div class="card mb-4"><div class="card-body"><div class="row align-items-center"><div class="col-md-2 text-center"><img src="https://i.pravatar.cc/150?u=student1" class="rounded-circle img-thumbnail"></div><div class="col-md-10"><p class="mb-1"><strong>Mã HS:</strong> HS-001</p><p class="mb-1"><strong>Lớp:</strong> 10A1 - <strong>GVCN:</strong> Cô Nguyễn Thị Mai</p><p class="mb-1"><strong>Ngày sinh:</strong> 10/05/2008 - <strong>Giới tính:</strong> Nam</p><p class="mb-0"><strong>Phụ huynh:</strong> Ông Nguyễn Văn B - <strong>SĐT:</strong> 0909123456</p></div></div></div></div><div class="card"><div class="card-body"><ul class="nav nav-tabs nav-tabs-responsive mb-3"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-class-history">Lịch sử Lớp học</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-attendance-history">Lịch sử Điểm danh</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-tuition-history">Lịch sử Học phí</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-achievements">Thành tích & Chứng nhận</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-class-history"><table class="table table-sm table-bordered"><thead><th>Năm học</th><th>Lớp</th><th>Kết quả</th><th>Hạnh kiểm</th></thead><tbody><tr><td>2023-2024</td><td>9A1</td><td>Giỏi</td><td>Tốt</td></tr></tbody></table></div><div class="tab-pane" id="tab-attendance-history"><table class="table table-sm table-bordered"><thead><th>Ngày</th><th>Trạng thái</th><th>Lý do</th></thead><tbody><tr><td>09/07/2024</td><td><span class="badge bg-danger">Vắng (P)</span></td><td>Nghỉ ốm</td></tr></tbody></table></div><div class="tab-pane" id="tab-tuition-history"><table class="table table-sm table-bordered"><thead><th>Kỳ thu</th><th>Số tiền</th><th>Trạng thái</th><th>Ngày đóng</th></thead><tbody><tr><td>Học phí HK1 24-25</td><td>5,000,000đ</td><td><span class="badge bg-danger">Chưa đóng</span></td><td></td></tr></tbody></table></div><div class="tab-pane" id="tab-achievements"><table class="table table-sm table-bordered"><thead><th>Ngày</th><th>Loại</th><th>Nội dung</th></thead><tbody><tr><td>05/09/2024</td><td>Khen thưởng</td><td>HSG cấp Trường môn Toán</td></tr></tbody></table></div></div></div></div>`,
        classes: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Danh sách Lớp học</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#class-modal"><i class="fas fa-plus me-2"></i>Thêm Lớp</button></div><div class="card"><div class="card-header">Lớp học năm 2024-2025</div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Tên Lớp</th><th>Khối</th><th>GVCN</th><th class="text-center">Sĩ số</th><th>Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody>
            <tr data-id="1" data-class_name="10A1" data-grade="10" data-teacher="Nguyễn Thị Mai" data-size="40" data-status="Đang hoạt động"><td>10A1</td><td>10</td><td>Nguyễn Thị Mai</td><td class="text-center">40</td><td><span class="badge bg-success">Đang hoạt động</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit" data-bs-toggle="modal" data-bs-target="#class-modal"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr>
            </tbody></table></div></div></div>`,
        attendance: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Quản lý Điểm danh</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#attendance-entry-modal"><i class="fas fa-plus me-2"></i>Điểm danh hôm nay</button></div><div class="card"><div class="card-header">Lịch sử điểm danh</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><input type="date" class="form-control" value="2024-07-11"></div><div class="col-md-4"><select class="form-select"><option>Tất cả lớp</option><option>10A1</option></select></div></div><div class="table-responsive"><table class="table table-hover"><thead><th>Ngày</th><th>Lớp</th><th class="text-center">Sĩ số</th><th class="text-center">Vắng</th><th class="text-center">Tỷ lệ</th><th>Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>11/07/2024</td><td>10A1</td><td class="text-center">40</td><td class="text-center">1</td><td class="text-center">97.5%</td><td><span class="badge bg-success">Hoàn tất</span></td><td class="text-center"><button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#attendance-entry-modal"><i class="fas fa-edit"></i> Sửa</button></td></tr></tbody></table></div></div></div>`,
        timetable: `<h3 class="mb-4">Thời khóa biểu</h3><div class="card"><div class="card-body"><div class="table-responsive"><table class="table table-bordered text-center"><thead><tr><th>Tiết</th><th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th><th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th></tr></thead><tbody><tr><td>1</td><td>Toán</td><td>Lý</td><td>Văn</td><td>Hóa</td><td>Sử</td><td>GDCD</td></tr></tbody></table></div></div></div>`,
        grades: `<div class="card shadow-sm"><div class="card-header">Bảng điểm Lớp 10A1 - Môn Toán</div><div class="card-body"><div class="table-responsive"><table class="table table-bordered table-sm text-center"><thead><tr><th>STT</th><th class="text-start">Họ Tên</th><th>Miệng</th><th>15p</th><th>1 Tiết</th><th>HK</th><th>TBm</th></tr></thead><tbody><tr><td>1</td><td class="text-start">Nguyễn Văn An</td><td>9</td><td>8</td><td>8.5</td><td>9</td><td class="fw-bold">8.6</td></tr></tbody></table></div></div></div>`,
        'teaching-log': `<div class="card"><div class="card-header">Lịch sử ghi sổ đầu bài</div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Ngày</th><th>Tiết</th><th>Lớp</th><th>Môn</th><th>GV</th><th>Nội dung</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>10/07</td><td>1</td><td>10A1</td><td>Toán</td><td>Nguyễn Thị Mai</td><td>Bài 1: Phương trình bậc hai</td><td class="text-center"><button class="btn btn-sm btn-outline-warning"><i class="fas fa-edit"></i></button></td></tr></tbody></table></div></div></div>`,
        teachers: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Hồ sơ Cán bộ - Giáo viên - Nhân viên</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teacher-modal"><i class="fas fa-plus me-2"></i>Thêm mới</button></div><div class="card"><div class="card-header">Danh sách nhân sự</div><div class="card-body"><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Mã NS</th><th>Họ và Tên</th><th>Phòng/Tổ</th><th>Chức vụ</th><th>Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody>
            <tr><td>GV-001</td><td><a href="#" class="nav-link p-0 fw-bold" data-view="teacher-detail">Nguyễn Thị Mai</a></td><td>Tổ Toán-Tin</td><td>Tổ trưởng</td><td><span class="badge bg-success">Đang công tác</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-warning btn-edit"><i class="fas fa-edit"></i></button><button class="btn btn-outline-danger"><i class="fas fa-trash"></i></button></div></td></tr>
            </tbody></table></div></div></div>`,
        'teacher-detail': `<h3 class="mb-4">Hồ sơ chi tiết: Nguyễn Thị Mai</h3><div class="card mb-4"><div class="card-body"><div class="row align-items-center"><div class="col-md-2 text-center"><img src="https://i.pravatar.cc/150?u=teacher1" class="rounded-circle img-thumbnail"></div><div class="col-md-10"><p class="mb-1"><strong>Mã NS:</strong> GV-001</p><p class="mb-1"><strong>Chức vụ:</strong> Tổ trưởng - <strong>Tổ:</strong> Toán-Tin</p><p class="mb-1"><strong>Ngày vào làm:</strong> 15/08/2010 - <strong>Trình độ:</strong> Thạc sĩ</p><p class="mb-0"><strong>Email:</strong> maints@school.edu.vn - <strong>SĐT:</strong> 0987654321</p></div></div></div></div><div class="card"><div class="card-body"><ul class="nav nav-tabs nav-tabs-responsive mb-3"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-teaching-assignment">Phân công giảng dạy</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-work-history">Quá trình Công tác</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-teaching-assignment"><table class="table table-sm table-bordered"><thead><th>Năm học</th><th>Lớp</th><th>Môn học</th><th>Vai trò</th></thead><tbody><tr><td>2024-2025</td><td>10A1</td><td>Toán</td><td>GVCN</td></tr></tbody></table></div><div class="tab-pane" id="tab-work-history"><ul class="nav nav-pills mb-3"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-commendations">Khen thưởng</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-discipline-gv">Kỷ luật</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-commendations"><div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#teacher-discipline-modal"><i class="fas fa-plus"></i> Thêm</button></div><table class="table table-sm table-bordered"><thead><th>Ngày</th><th>Số QĐ</th><th>Nội dung</th><th>Hành động</th></thead><tbody><tr><td>20/11/2023</td><td>123/QĐ-KT</td><td>Đạt danh hiệu GVDG cấp Tỉnh</td><td class="text-center"><button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr></tbody></table></div><div class="tab-pane" id="tab-discipline-gv"><table class="table table-sm table-bordered"><thead class="text-center text-muted"><tr><th>Chưa có dữ liệu</th></tr></thead></table></div></div></div></div></div></div>`,
        'teacher-attendance': `<div class="card"><div class="card-header">Lịch sử chấm công</div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Ngày</th><th>Nhân viên</th><th>Giờ vào</th><th>Giờ ra</th><th class="text-end">Tổng giờ</th><th>Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>10/07/2024</td><td>Nguyễn Thị Mai</td><td>07:28</td><td>16:35</td><td class="text-end">8.1h</td><td><span class="badge bg-success">Đúng giờ</span></td><td class="text-center"><button class="btn btn-sm btn-outline-warning"><i class="fas fa-edit"></i></button></td></tr></tbody></table></div></div></div>`,
        leave: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Quản lý Nghỉ phép (GV-NV)</h3><button class="btn btn-primary"><i class="fas fa-plus me-2"></i>Tạo đơn</button></div><div class="row mb-4"><div class="col-md-4"><div class="card text-center text-bg-primary h-100"><div class="card-header bg-transparent border-0 fw-bold">TỔNG PHÉP NĂM</div><div class="card-body fs-3 fw-bolder">12</div></div></div><div class="col-md-4"><div class="card text-center text-bg-warning h-100"><div class="card-header bg-transparent border-0 fw-bold">ĐÃ NGHỈ</div><div class="card-body fs-3 fw-bolder">4.5</div></div></div><div class="col-md-4"><div class="card text-center text-bg-success h-100"><div class="card-header bg-transparent border-0 fw-bold">CÒN LẠI</div><div class="card-body fs-3 fw-bolder">7.5</div></div></div></div><div class="card"><div class="card-header">Danh sách đơn nghỉ phép</div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Người gửi</th><th>Phòng/Tổ</th><th>Từ ngày</th><th>Đến ngày</th><th>Lý do</th><th class="text-center">Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>Trần Văn Hùng</td><td>Tổ Lý-Hóa-Sinh</td><td>11/07/2024</td><td>12/07/2024</td><td>Việc gia đình</td><td class="text-center"><span class="badge bg-warning text-dark">Chờ duyệt</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-check"></i></button></div></td></tr></tbody></table></div></div></div>`,
        tuition: `<div class="card"><div class="card-header">Theo dõi thu học phí - Học kỳ 1 (2024-2025)</div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Mã HS</th><th>Họ và Tên</th><th>Lớp</th><th class="text-end">Phải thu</th><th class="text-center">Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>HS-001</td><td>Nguyễn Văn An</td><td>10A1</td><td class="text-end">5,000,000đ</td><td class="text-center"><span class="badge bg-success">Đã đóng</span></td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-outline-info"><i class="fas fa-receipt"></i></button></div></td></tr></tbody></table></div></div></div>`,
        'finance-vouchers': `<div class="card"><div class="card-body"><ul class="nav nav-tabs mb-3"><li class="nav-item"><a class="nav-link active" href="#">Phiếu Thu</a></li><li class="nav-item"><a class="nav-link" href="#">Phiếu Chi</a></li></ul></div></div>`,
        communication: `<div class="d-flex justify-content-between align-items-center mb-4"><h3>Sổ liên lạc điện tử</h3><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#feedback-modal"><i class="fas fa-paper-plane me-2"></i>Gửi phản ánh</button></div><div class="card chat-container"><div class="row g-0"><div class="col-12 col-lg-4 border-end"><div class="card-header">Hội thoại</div><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action active"><div class="d-flex align-items-center"><img src="https://i.pravatar.cc/40?u=ph1" class="rounded-circle me-3" width="40"><div class="flex-grow-1"><strong>PH em Nguyễn Văn An</strong></div></div></a></div></div><div class="col-12 col-lg-8"><div class="card-header d-flex align-items-center"><img src="https://i.pravatar.cc/40?u=ph1" class="rounded-circle me-3" width="40"><strong>PH em Nguyễn Văn An</strong></div><div class="card-body chat-body bg-light-subtle p-3"><div class="chat-message right"><div class="message-content">Chào anh/chị.</div></div></div><div class="card-footer"><div class="input-group"><input type="text" class="form-control" placeholder="Nhập tin nhắn..."><button class="btn btn-primary"><i class="fas fa-paper-plane"></i></button></div></div></div></div></div>`,
        'parent-corner': `<h3 class="mb-4">Góc học tập: <span class="text-primary">Nguyễn Văn An</span></h3><div class="card shadow-sm"><div class="card-body"><ul class="nav nav-tabs nav-tabs-responsive mb-3"><li class="nav-item"><a class="nav-link active" href="#">Tổng quan</a></li><li class="nav-item"><a class="nav-link" href="#">Thời khóa biểu</a></li><li class="nav-item"><a class="nav-link" href="#">Điểm danh</a></li><li class="nav-item"><a class="nav-link" href="#">Bảng điểm</a></li></ul></div></div>`,
        'leave-requests': `<div class="card"><div class="card-header">Danh sách đơn từ Phụ huynh</div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Ngày gửi</th><th>Học sinh</th><th>Lớp</th><th>Ngày nghỉ</th><th class="text-center">Trạng thái</th><th class="text-center">Hành động</th></tr></thead><tbody><tr><td>10/07</td><td>Trần Thị Bình</td><td>10A1</td><td>11/07/2024</td><td class="text-center"><span class="badge bg-warning text-dark">Chờ duyệt</span></td><td class="text-center"><button class="btn btn-sm btn-outline-info"><i class="fas fa-eye"></i></button></td></tr></tbody></table></div></div></div>`,
        announcements: `<div class="card"><div class="card-header">Danh sách thông báo</div><div class="card-body">...</div></div>`,
        'school-data': `<div class="card"><div class="card-header">Dữ liệu Trường học</div></div>`,
        roles: `<h3 class="mb-4">Phân quyền & Vai trò</h3>`,
        'user-guide': `<h3 class="mb-4">Hướng dẫn sử dụng</h3>`,
        'my-profile': `<h3 class="mb-4">Thông tin cá nhân</h3>`,
    };
    // === END: All View Templates ===

    // === START: JS Functions ===
    function destroyCharts() {
        if (chart1) chart1.destroy();
        if (chart2) chart2.destroy();
        if (radarChart) radarChart.destroy();
        if (barChart) barChart.destroy();
    }

    function updateSidebarTooltips() {
        bsTooltipList.forEach(t => t.dispose());
        bsTooltipList = [];
        const isCollapsed = document.body.classList.contains('sidebar-collapsed');
        const links = sidebar.querySelectorAll('.components > li > a, .components > div > a');
        if (isCollapsed) {
            links.forEach(link => {
                const title = link.querySelector('span')?.textContent;
                if (title) {
                    link.setAttribute('data-bs-toggle', 'tooltip');
                    link.setAttribute('data-bs-placement', 'right');
                    link.setAttribute('title', title);
                }
            });
            bsTooltipList = [...sidebar.querySelectorAll('[data-bs-toggle="tooltip"]')].map(el => new bootstrap.Tooltip(el));
        }
    }

    function renderView(viewId) {
        destroyCharts();
        globalSearchInput.placeholder = searchPlaceholders[viewId] || 'Tìm kiếm...';
        mainContentArea.innerHTML = viewTemplates[viewId] || `<div class="p-5"><h3>Chức năng [${viewId}] đang được phát triển...</h3><p>Vui lòng quay lại sau.</p></div>`;
        mainContentArea.classList.add('active');
        setTimeout(() => mainContentArea.classList.remove('active'), 500);

        // Chart rendering logic
        if (viewId === 'dashboard') {
            const perfChartEl = document.getElementById('performanceByGradeChart');
            if(perfChartEl) chart1 = new Chart(perfChartEl.getContext('2d'), { type: 'bar', data: { labels: ['Khối 10', 'Khối 11', 'Khối 12'], datasets: [{ label: 'Giỏi', data: [25, 30, 28], backgroundColor: 'rgba(40, 167, 69, 0.7)' }, { label: 'Khá', data: [45, 40, 42], backgroundColor: 'rgba(23, 162, 184, 0.7)' }, { label: 'TB', data: [20, 22, 18], backgroundColor: 'rgba(255, 193, 7, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
            const tuitionChartEl = document.getElementById('tuitionStatusChart');
            if(tuitionChartEl) chart2 = new ApexCharts(tuitionChartEl, { series: [85, 10, 5], chart: { type: 'donut', height: 320 }, labels: ['Đã thu', 'Chưa thu', 'Miễn giảm'], colors: ['#28a745', '#dc3545', '#17a2b8'], legend: { position: 'bottom' } });
            if (chart2) chart2.render();
        } else if (viewId === 'analytics') {
            const gradeDistEl = document.getElementById('gradeDistributionChart');
            if(gradeDistEl) barChart = new Chart(gradeDistEl.getContext('2d'), { type: 'bar', data: { labels: ['Yếu (<5)', 'TB (5-6.4)', 'Khá (6.5-7.9)', 'Giỏi (8-10)'], datasets: [{ label: 'Số lượng HS', data: [12, 45, 58, 25], backgroundColor: ['#dc3545', '#ffc107', '#0dcaf0', '#198754'] }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' } });
            const classCompEl = document.getElementById('classComparisonChart');
            if(classCompEl) radarChart = new Chart(classCompEl.getContext('2d'), { type: 'radar', data: { labels: ['Toán', 'Lý', 'Hóa', 'Văn', 'Anh'], datasets: [{ label: '10A1', data: [8.1, 7.5, 7.8, 8.0, 8.5], fill: true, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgb(255, 99, 132)' }, { label: '10A2', data: [7.9, 8.0, 8.2, 7.7, 8.3], fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
    }
    
    function setActiveLink(targetLink) {
        document.querySelectorAll('#sidebar .components li').forEach(li => li.classList.remove('active'));
        // Special case for top-level menu items
        document.querySelectorAll('#sidebar .components > li > a:not([data-bs-toggle="collapse"])').forEach(a => a.parentElement.classList.remove('active'));

        if (targetLink) {
            let parentLi = targetLink.closest('li');
            if (parentLi) {
                parentLi.classList.add('active');
                const submenu = targetLink.closest('.collapse');
                if (submenu) {
                    const trigger = document.querySelector(`a[href="#${submenu.id}"]`);
                    if (trigger) {
                        trigger.closest('li').classList.add('active');
                         if (!submenu.classList.contains('show')) {
                            new bootstrap.Collapse(submenu).show();
                        }
                    }
                }
            }
        }
    }

    function toggleMobileSidebar() {
        sidebar.classList.toggle('show');
        sidebarOverlay.classList.toggle('active');
    }

    desktopSidebarToggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('sidebar-collapsed');
        updateSidebarTooltips();
    });
    mobileSidebarToggleBtn.addEventListener('click', toggleMobileSidebar);
    sidebarOverlay.addEventListener('click', toggleMobileSidebar);

    document.body.addEventListener('click', (e) => {
        const link = e.target.closest('.nav-link, .nav-link-profile');
        if (link && link.dataset.view) {
            e.preventDefault();
            renderView(link.dataset.view);
            setActiveLink(link.closest('#sidebar a'));
            if (window.innerWidth < 992 && sidebar.classList.contains('show')) {
                toggleMobileSidebar();
            }
        }
    });

    // Modal form handler
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = this.querySelector('form');
            if (!form) return;
            if (button && (button.classList.contains('btn-edit') || button.closest('.btn-edit'))) {
                const row = button.closest('tr');
                if (!row) return;
                const rowData = row.dataset;
                for (const key in rowData) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) input.value = rowData[key];
                }
            } else {
                form.reset();
                const idInput = form.querySelector('[name="id"]');
                if(idInput) idInput.value = '';
            }
        });
    });

    // Initial Load
    renderView('dashboard');
    setActiveLink(document.querySelector(`#sidebar .nav-link[data-view="dashboard"]`));
    updateSidebarTooltips();
    // === END: JS Functions ===
});
</script>
</body>
</html>
